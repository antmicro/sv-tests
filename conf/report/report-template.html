{# vim: set ts=2 sts=2 sw=2 et: #}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>SystemVerilog Report</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>

    {# Global parameters for scripts and stylesheets #}
    <script>
      var TOOL_NAMES = [{{report.tools.keys()|sort|map('escape_js_str')|map('quote')|join(', ')}}];
      var TOOLS_COUNT = {{report.tools|length}};
    </script>
    <style>:root { --TOOLS_COUNT: {{report.tools|length}}; }</style>

    <link rel="stylesheet" type="text/css" href="report.css">
    <script type="text/javascript" charset="utf8" src="report.js"></script>
    <script type="text/javascript" charset="utf8" src="filter.js"></script>
  </head>
  <body>
    <header>
      <h1><a href="https://github.com/chipsalliance/sv-tests">SV-Tests</a></h1>
      <p><a href="https://github.com/chipsalliance/sv-tests"><em>Test suite to check compliance with the SystemVerilog LRM by chapter as well as some real-world cores and test-cases.</em></a></p>
    </header>
    <main>
      <section id="filter-section">
        <button onclick="toggleFilters()">Show advanced filters (experimental)</button>
        <section style="display: none;" id="filter">
          <ul class="filter-entries">
          </ul>
          <div>
            <button class="filter-add" onclick="addOptions()">Add</button>
            <button class="filter-apply" onclick="applyFilter()">Apply</button>
            <button class="filter-remove" onclick="removeAll()">Remove all filters</button>
          </div>
        </section>
      </section>
      <table id="report_table" class="dataTable">
        <thead>
          <tr>
            <th></th>
            <th></th>
            {% for tool, tool_results in report.tools|dictsort %}
            <th title="{{tool_results.version|escape_attr}}" style="--z: {{loop.length - loop.index}}">
              <a class="tool_link" target="_blank" href="{{tool_results.url}}">{{tool|e}}</a>
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for tag, tag_info in report.tags|dictsort %}
          {%   set types_used_in_the_row = [] %}
          {%   for tool, tool_results in report.tools|dictsort %}
          {%     if tag in tool_results.tags %}
          {%       for type in tool_results.tags[tag].types %}
          {%         if type not in types_used_in_the_row %}
          {%           set _ = types_used_in_the_row.append(type) %}
          {%         endif %}
          {%       endfor %}
          {%     endif %}
          {%   endfor %}
          <tr class="{{types_used_in_the_row|join(' ')}}" data-tag="{{tag|e}}">
            <th title="{{tag_info.description|escape_attr}}">
              {%- if tag_info.url -%}
              <a class="tag_link" target="_blank" href="{{tag_info.url}}">{{tag_info.description|e}}</a>
              {%- else -%}
              {{tag_info.description|e}}
              {%- endif -%}
            </th>
            <th title="{{tag_info.description|escape_attr}}">{{tag|lower|e}}</th>
            {% for tool, tool_results in report.tools|dictsort %}
            {%   set attrs = [] %}
            {%   if tag in tool_results.tags %}
            {%     set tag_results = tool_results.tags[tag] %}
            {%     set test_status = tag_results.status|string %}
            {%     if test_status != 'test-na' %}
            {%       set _ = attrs.append('class=' ~ (test_status|quote)) %}
            {%       set _ = attrs.append('data-tool=' ~ (tool|lower|escape_attr|quote)) %}
            {%       if test_status == 'test-varied' %}
            {%         set percentage = '%0.0f'|format(100.0 * tag_results.passed_tests / tag_results.tests|length) %}
            {%         set _ = attrs.append('style="--val: '~(percentage)~'%"') %}
            {%       endif %}
            {%     endif %}
            {%   endif %}
            {%   if attrs|length %}
            <td {{attrs|join(' ')}}>{{tag_results.passed_tests}}/{{tag_results.tests|length}}</td>
            {%   else %}
            <td></td>
            {%   endif %}
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2">Total tests passed</th>
            {% for tool, tool_results in report.tools|dictsort %}
            {%   set passed_tests = tool_results.total_passed_tests %}
            {%   set total_tests = tool_results.total_tests %}
            {%   set passed_tests_percentage = '%0.0f'|format(100.0 * passed_tests / total_tests) %}
            <td class="test-varied" style="--val: {{passed_tests_percentage}}%" title="{{tool|lower|e}} ({{passed_tests_percentage}}%)">{{passed_tests}}/{{total_tests}}</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Total tags passed</th>
            {% for tool, tool_results in report.tools|dictsort %}
            {%   set passed_tags = tool_results.total_passed_tags %}
            {%   set tested_tags = tool_results.total_tested_tags %}
            {%   set passed_tags_percentage = '%0.0f'|format(100.0 * passed_tags / tested_tags) %}
            <td class="test-varied" style="--val: {{passed_tags_percentage}}%" title="{{tool|lower|e}} ({{passed_tags_percentage}}%)">{{passed_tags}}/{{tested_tags}}</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Total time elapsed</th>
            {% for tool, tool_results in report.tools|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tool_results.total_time)}}s</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">User time elapsed</th>
            {% for tool, tool_results in report.tools|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tool_results.user_time)}}s</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">System time elapsed</th>
            {% for tool, tool_results in report.tools|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tool_results.system_time)}}s</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Maximum ram usage</th>
            {% for tool, tool_results in report.tools|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tool_results.max_ram_usage)}} MB</td>
            {% endfor %}
          </tr>
          <tr>
            <th colspan="2">Average throughput passed for inputs &gt; 1KiB</th>
            {% for tool, tool_results in report.tools|dictsort %}
            <td title="{{tool|lower|e}}">{{'%0.0f'|format(tool_results.passed_throughput|float)}} KiB/s</td>
            {% endfor %}
          </tr>
        </tfoot>
      </table>
      <section id="summary-section">
        <a href="report.csv">Download a summary in csv</a>
      </section>
    </main>
    <footer id="footer">
      <p>
        Generated using <a href="https://github.com/chipsalliance/sv-tests">sv-tests</a>,
        revision: <a href="https://github.com/chipsalliance/sv-tests/commit/{{revision}}">{{revision}}</a>,
        {% if build_id != 'local' %}
        build_id: <a href="{{'https://github.com/chipsalliance/sv-tests/actions/runs/' ~ build_id|string}}">{{build_id}}</a>,
        {% else %}
        build_id: {{build_id}},
        {% endif %}
        date: {{datetime}}.
      </p>
    </footer>

    <div class="c_test-details-panel s_hidden">
      <iframe class="p_log" name="log-frame"></iframe>
      <iframe class="p_file" name="file-frame"></iframe>
      <div class="p_tests-list">
        <template class="p_item-template">
          <button class="p_item"><slot name="test-name"></slot></button>
        </template>
        <button class="p_close-button">close</button>
      </div>
    </div>
  </body>
</html>
